<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Estudiantes</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root { --brand:#2F338F; }
    html,body{height:100%}
    body{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    .card{box-shadow:0 20px 60px rgba(0,0,0,.08)}
    input,select{ outline:none }
    input:focus,select:focus{ border-color:var(--brand) !important; box-shadow:0 0 0 6px rgba(47,51,143,.13) }
    .logo-row img{ height:46px; width:auto; object-fit:contain }
    code{ background:#eef2ff; padding:.1rem .3rem; border-radius:.4rem }
    .chip{ display:inline-flex; align-items:center; gap:.4rem; padding:.15rem .55rem; border-radius:999px; font-size:.72rem; font-weight:600 }
    .chip-indigo{ background:#eef2ff; color:#29337a; }
    .chip-emerald{ background:#ecfdf5; color:#065f46; }
    .chip-amber{ background:#fffbeb; color:#92400e; }
    .chip-slate{ background:#f1f5f9; color:#334155; }

    /* Pulido de layout para eliminar huecos extra */
    .section-tight { padding-top: 0; padding-bottom: 0; }
    #envios-section.hidden { display: none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 via-white to-indigo-50 text-slate-800">

  <!-- Hero compacto (sin huecos) -->
  <div class="py-10 section-tight">
    <div class="mx-auto max-w-7xl grid grid-cols-1 lg:grid-cols-2 gap-8 items-center px-6">
      <aside class="hidden lg:block">
        <div class="flex items-center gap-4 mb-8 logo-row">
          <img src="assets/ueb.png" alt="UEB" />
          <img src="assets/rrd.png" alt="Carrera" />
        </div>
        <h1 class="text-3xl font-semibold leading-tight">Gestión de Estudiantes</h1>
        <p class="mt-3 text-slate-600">Portal para subir tareas por semanas y parciales. Acceso por número de cédula.</p>
        <ul class="mt-6 space-y-2 text-slate-700 text-sm">
          <li>• Parciales: 1 y 2</li>
          <li>• Validación de nombre de archivo</li>
          <li>• Registro automático en Google Sheets y Drive</li>
          <li>• Tareas <b>Individuales / Grupales / Curso</b></li>
        </ul>
      </aside>

      <main class="">
        <div class="card bg-white rounded-2xl p-6 md:p-8">
          <div class="flex lg:hidden items-center gap-4 mb-6 logo-row">
            <img src="assets/ueb.png" alt="UEB" />
            <img src="assets/rrd.png" alt="Carrera" />
          </div>

          <!-- ========== LOGIN ========== -->
          <section id="view-login" class="space-y-6">
            <header>
              <h2 class="text-2xl md:text-3xl font-semibold">Ingreso por cédula</h2>
              <p class="text-slate-600 mt-1">Ingresa tu número de cédula para acceder al panel.</p>
            </header>

            <form id="form-login" class="space-y-3">
              <div>
                <label for="cedula" class="block text-sm font-medium text-slate-700 mb-1">Número de cédula</label>
                <input id="cedula" name="cedula" inputmode="numeric" pattern="^(\d{10}|\d{13})$" maxlength="13"
                       placeholder="Ej: 0102030405"
                       class="w-full rounded-xl border border-slate-300 px-4 py-3" required>
                <p class="text-xs text-slate-500 mt-1">* Debe estar registrado en la base de datos.</p>
              </div>
              <div class="flex justify-end">
                <button type="submit"
                        class="inline-flex justify-center items-center rounded-xl bg-[var(--brand)] text-white px-6 py-3 font-semibold hover:opacity-95 active:opacity-90 transition">
                  Acceder
                </button>
              </div>
            </form>
          </section>

          <!-- ========== PANEL (FORM) ========== -->
          <section id="view-panel" class="hidden space-y-4">
            <div class="flex items-center justify-between gap-4 flex-wrap">
              <div>
                <h2 class="text-2xl md:text-3xl font-semibold">Bienvenido</h2>
                <p class="text-slate-600">
                  <span id="alumno-nombre" class="font-semibold"></span> &middot; Cédula:
                  <span id="alumno-cedula" class="font-mono"></span>
                </p>
              </div>
              <div class="flex gap-2">
                <a id="btn-ver-envios" href="#envios-section" class="text-sm text-[var(--brand)] underline">Ver mis envíos</a>
                <button id="btn-salir" class="text-sm text-slate-600 hover:text-red-600">Salir</button>
              </div>
            </div>

            <form id="form-upload" class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Materia -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-1">Materia</label>
                <select id="materia" class="w-full rounded-xl border border-slate-300 px-4 py-3" required>
                  <option value="" disabled selected>Selecciona</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Parcial</label>
                <select id="parcial" class="w-full rounded-xl border border-slate-300 px-4 py-3" required>
                  <option value="" disabled selected>Selecciona</option>
                  <option value="1">Parcial 1</option>
                  <option value="2">Parcial 2</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Semana</label>
                <select id="semana" class="w-full rounded-xl border border-slate-300 px-4 py-3" required>
                  <option value="" disabled selected>Selecciona</option>
                </select>
              </div>

              <!-- Tipo de entrega -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-1">Tipo de entrega</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <label class="flex items-center gap-2 rounded-xl border px-4 py-3 hover:bg-slate-50 cursor-pointer">
                    <input type="radio" name="tipoEntrega" value="INDIVIDUAL" class="accent-[var(--brand)]" checked>
                    <span>Individual</span>
                  </label>
                  <label class="flex items-center gap-2 rounded-xl border px-4 py-3 hover:bg-slate-50 cursor-pointer">
                    <input type="radio" name="tipoEntrega" value="GRUPAL" class="accent-[var(--brand)]">
                    <span>Grupal</span>
                  </label>
                  <label class="flex items-center gap-2 rounded-xl border px-4 py-3 hover:bg-slate-50 cursor-pointer">
                    <input type="radio" name="tipoEntrega" value="CURSO" class="accent-[var(--brand)]">
                    <span>Curso</span>
                  </label>
                </div>
                <p class="text-xs text-slate-500 mt-1">En grupal selecciona a tus integrantes; en curso no es necesario.</p>
              </div>

              <!-- Integrantes (solo GRUPAL) -->
              <div id="grupo-container" class="md:col-span-2 hidden">
                <div class="rounded-xl border border-slate-200 p-4 bg-slate-50">
                  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div class="font-medium">Integrantes del grupo</div>
                    <div class="flex items-center gap-2">
                      <input id="buscarIntegrante" placeholder="Buscar por cédula o nombre..." class="rounded-lg border border-slate-300 px-3 py-2 text-sm w-64">
                      <span class="text-xs text-slate-500" id="countSel">0 seleccionados</span>
                    </div>
                  </div>
                  <div id="listaIntegrantes" class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2 max-h-64 overflow-auto pr-1"></div>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">N.º de tarea</label>
                <input id="numeroTarea" type="number" min="1" max="99" placeholder="01"
                       class="w-full rounded-xl border border-slate-300 px-4 py-3" required>
                <p class="text-xs text-slate-500 mt-1">Usa 01, 02, 03…</p>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Archivo</label>
                <input id="archivo" type="file" class="w-full rounded-xl border border-slate-300 px-4 py-2 bg-white" required>
                <p class="text-xs text-slate-500 mt-1">Formatos: PDF, DOCX, PPTX, XLSX, JPG, PNG (≤ 25 MB)</p>
              </div>

              <!-- Renombrado (sugerencia con sufijo según tipo) -->
              <div class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl p-4 space-y-2">
                <div class="flex items-center justify-between gap-2">
                  <p class="text-sm">
                    Nombre base:
                    <code class="font-mono text-[var(--brand)]" id="nombre-ejemplo">ABBR_SEMANA_1_NOMBRE_APELLIDO_01</code>
                  </p>
                  <span id="chip-tipo" class="chip chip-indigo">Individual</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2 items-center">
                  <div>
                    <label class="block text-xs text-slate-500 mb-1">Nombre final</label>
                    <input id="nombre-final" type="text" class="w-full rounded-lg border border-slate-300 px-3 py-2 font-mono" placeholder="Selecciona un archivo para sugerir la extensión">
                  </div>
                  <button id="btn-aplicar-nombre" type="button" class="text-sm px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">Aplicar sugerido</button>
                </div>
                <p class="text-xs text-slate-500">El tipo se identifica en el nombre sugerido, en la tabla y en Drive.</p>
              </div>

              <div class="md:col-span-2 flex justify-end gap-3 mt-2">
                <button type="reset" class="px-5 py-3 rounded-xl border border-slate-300">Limpiar</button>
                <button type="submit" class="px-5 py-3 rounded-xl bg-[var(--brand)] text-white font-semibold hover:opacity-95 active:opacity-90">
                  Subir
                </button>
              </div>
            </form>
          </section>

        </div>
      </main>
    </div>
  </div>

  <!-- ========== MIS ENVIOS (oculto por defecto) ========== -->
  <section id="envios-section" class="px-6 pb-10 hidden">
    <div class="max-w-7xl mx-auto card bg-white rounded-2xl p-6 md:p-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div class="flex items-center gap-3">
          <h3 class="text-2xl font-semibold">Mis envíos</h3>
          <span id="envios-loading" class="hidden text-sm text-slate-500">Actualizando…</span>
        </div>
        <div class="flex gap-3 items-center">
          <input id="searchEnvios" class="rounded-lg border border-slate-300 px-3 py-2 text-sm" placeholder="Buscar...">
          <label class="text-sm text-slate-600">Por página
            <select id="pageSize" class="ml-2 rounded-md border border-slate-300 px-2 py-1 text-sm">
              <option>10</option><option>25</option><option>50</option><option>100</option>
            </select>
          </label>
          <button id="btn-cerrar-envios" class="px-3 py-2 rounded-md border border-slate-300 text-sm hover:bg-slate-50">Cerrar</button>
        </div>
      </div>

      <div class="overflow-x-auto rounded-xl border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="text-left px-4 py-2">Fecha</th>
              <th class="text-left px-4 py-2">Materia</th>
              <th class="text-left px-4 py-2">Parcial</th>
              <th class="text-left px-4 py-2">Semana</th>
              <th class="text-left px-4 py-2">Tarea</th>
              <th class="text-left px-4 py-2">Tipo</th>
              <th class="text-left px-4 py-2">Grupo</th>
              <th class="text-left px-4 py-2">Archivo</th>
            </tr>
          </thead>
          <tbody id="envios-tbody"></tbody>
        </table>
      </div>

      <div class="flex items-center justify-between mt-3 text-sm">
        <div id="envios-count" class="text-slate-600">0 registros</div>
        <div class="flex gap-2">
          <button id="firstPage" class="px-3 py-1 rounded border border-slate-300">«</button>
          <button id="prevPage"  class="px-3 py-1 rounded border border-slate-300">‹</button>
          <span id="pageInfo" class="px-2">1 / 1</span>
          <button id="nextPage"  class="px-3 py-1 rounded border border-slate-300">›</button>
          <button id="lastPage" class="px-3 py-1 rounded border border-slate-300">»</button>
        </div>
      </div>
    </div>
  </section>

  <script>
    /* ============ CONFIG ============ */
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzMWfuwghGGXh652PYLHfFH54HM-8S5T3IS7TyXTOXfrp2v3uZCdYyUTdYWvVXbax6-/exec';
    const SEMANAS_POR_PARCIAL = 15;
    const SIZE_LIMIT = 25 * 1024 * 1024;

    const TIPOS_PERMITIDOS = [
      'application/pdf','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/msword',
      'application/vnd.openxmlformats-officedocument.presentationml.presentation','application/vnd.ms-powerpoint',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','application/vnd.ms-excel','image/jpeg','image/png'
    ];

    const MATERIAS = [
      'Marco Legal para la Gestión del Riesgo','Administración','Sistemas de Información Geográfica Aplicado',
      'Evaluación de Amenazas','Evaluación de Vulnerabilidades','Cambio Climático'
    ];
    const MATERIA_ABBR = { 'Marco Legal para la Gestión del Riesgo': 'MLGR','Administración':'ADM','Sistemas de Información Geográfica Aplicado':'SIG','Evaluación de Amenazas':'EA','Evaluación de Vulnerabilidades':'EV','Cambio Climático':'CC' };

    /* ============ SESIÓN ============ */
    const SESSION_KEY = 'sesionAlumno';
    const SESSION_TTL_MIN = 180;
    const now = ()=>Date.now();

    const saveSession = (student)=> localStorage.setItem(SESSION_KEY, JSON.stringify({ student, ts: now() }));
    const loadSession = ()=>{ try{ const raw = localStorage.getItem(SESSION_KEY); if(!raw) return null; const obj = JSON.parse(raw); if(!obj || !obj.student) return null; const ageMin = (now() - (obj.ts||0)) / 60000; if(ageMin > SESSION_TTL_MIN) { localStorage.removeItem(SESSION_KEY); return null; } return obj.student; }catch{ return null; } };
    const touchSession = ()=>{ try{ const raw = localStorage.getItem(SESSION_KEY); if(!raw) return; const obj = JSON.parse(raw); obj.ts = now(); localStorage.setItem(SESSION_KEY, JSON.stringify(obj)); }catch{} };
    const clearSession = ()=> localStorage.removeItem(SESSION_KEY);

    /* ============ HELPERS ============ */
    const $ = (id)=>document.getElementById(id);
    const sinAcentos=(s)=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const slugUpper=(s)=>sinAcentos(String(s||'').trim()).replace(/[^A-Za-z\s]/g,'').replace(/\s+/g,'_').toUpperCase();
    const pad2=(n)=>String(n).padStart(2,'0');
    const getExt=(name)=>{ const m = String(name).match(/\.([^.]+)$/); return m? m[1] : ''; };
    const normId=(x)=> String(x||'').replace(/\D/g,'').replace(/^0+/, '') || '0';

    const abbr=(materia)=> MATERIA_ABBR[materia] || 'ABBR';

    // Sufijo textual según tipo
    const tipoSuffix = (tipo) => {
      const t = String(tipo||'INDIVIDUAL').toUpperCase();
      if (t==='GRUPAL') return '_GRUPAL';
      if (t==='CURSO')  return '_CURSO';
      return ''; // Individual sin sufijo
    };

    const nombreEsperadoBase=(materia,semana,nombres,apellidos,num)=>{
      const nom=slugUpper(nombres.split(' ')[0]||'NOMBRE');
      const ape=slugUpper(apellidos.split(' ')[0]||'APELLIDO');
      return `${abbr(materia)}_SEMANA_${semana}_${nom}_${ape}_${pad2(num)}`;
    };

    const nombreEsperadoConTipo=(materia,semana,nombres,apellidos,num,tipo)=>{
      return nombreEsperadoBase(materia,semana,nombres,apellidos,num) + tipoSuffix(tipo);
    };

    const toggleViews=(showLogin)=>{
      $('view-login').classList.toggle('hidden',!showLogin);
      $('view-panel').classList.toggle('hidden',showLogin);
    };

    /* ====== Validación EC ====== */
    function validarCedulaEC(ced) {
      if (!/^\d{10}$/.test(ced)) return false;
      const prov = parseInt(ced.slice(0,2),10);
      if (prov < 1 || prov > 24) return false;
      const d = ced.split('').map(n=>parseInt(n,10));
      const coef = [2,1,2,1,2,1,2,1,2];
      let suma = 0;
      for (let i=0;i<9;i++){ let prod = d[i]*coef[i]; if (prod >= 10) prod -= 9; suma += prod; }
      const mod = suma % 10; const verificador = (mod === 0) ? 0 : 10 - mod;
      return verificador === d[9];
    }
    function validarIdentificacionEC(ident){
      if (/^\d{10}$/.test(ident)) return validarCedulaEC(ident);
      if (/^\d{13}$/.test(ident)) return validarCedulaEC(ident.slice(0,10));
      return false;
    }

    /* ============ ESTADO ENVIOS ============ */
    let alumno=null, currentExt='', enviosData=[], filtered=[], pageSize=10, currentPage=1;
    let pollTimer=null; // desactivado por defecto

    (function fillMaterias(){
      const sel = $('materia'); MATERIAS.forEach(m=>{ const op=document.createElement('option'); op.value=m; op.textContent=m; sel.appendChild(op); });
    })();

    const renderSemanas=()=>{
      const parcial=$('parcial').value, sel=$('semana');
      sel.innerHTML='<option value="" disabled selected>Selecciona</option>';
      if(!parcial) return;
      for(let i=1;i<=SEMANAS_POR_PARCIAL;i++){ const op=document.createElement('option'); op.value=String(i); op.textContent=`Semana ${i}`; sel.appendChild(op); }
    };

    function updateChipTipo(tipo, integrantesCount=0){
      const chip = $('chip-tipo');
      if (tipo==='GRUPAL'){ chip.className='chip chip-amber'; chip.textContent=`Grupal (${integrantesCount||1})`; }
      else if (tipo==='CURSO'){ chip.className='chip chip-emerald'; chip.textContent='Curso'; }
      else { chip.className='chip chip-indigo'; chip.textContent='Individual'; }
    }

    const refreshEjemplo=()=>{
      const materia=$('materia').value || '';
      const semana=$('semana').value||'1';
      const num=$('numeroTarea').value||'1';
      const tipo = (document.querySelector('input[name="tipoEntrega"]:checked')?.value || 'INDIVIDUAL').toUpperCase();
      const base = nombreEsperadoConTipo(materia, semana, alumno?.nombres||'NOMBRE', alumno?.apellidos||'APELLIDO', num, tipo);
      $('nombre-ejemplo').textContent=base;
      if(currentExt){ $('nombre-final').placeholder = `${base}.${currentExt}`; }
    };

    $('btn-aplicar-nombre')?.addEventListener('click', ()=>{
      const base = $('nombre-ejemplo').textContent.trim();
      const ext = currentExt || 'pdf';
      $('nombre-final').value = `${base}.${ext}`;
    });

    $('archivo').addEventListener('change', ()=>{
      const f = $('archivo').files[0];
      if(!f){ currentExt=''; return; }
      currentExt = getExt(f.name) || currentExt || 'pdf';
      const base = $('nombre-ejemplo').textContent.trim();
      $('nombre-final').value = `${base}.${currentExt}`;
      $('nombre-final').placeholder = `${base}.${currentExt}`;
    });

    /* ============ LOGIN / LOGOUT ============ */
    $('form-login').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const cedula=$('cedula').value.trim(); if(!cedula) return;
      if (!validarIdentificacionEC(cedula)) return Swal.fire({icon:'warning',title:'Número inválido',text:'Revisa tu cédula (10) o RUC (13).'});
      Swal.showLoading();
      try{
        const res = await fetch(`${SCRIPT_URL}?action=auth&cedula=${encodeURIComponent(cedula)}`);
        const data = await res.json();
        if(data.ok){
          alumno=data.student; saveSession(alumno);
          $('alumno-nombre').textContent=`${alumno.nombres} ${alumno.apellidos}`;
          $('alumno-cedula').textContent=alumno.cedula;
          toggleViews(false); renderSemanas(); refreshEjemplo(); Swal.close();

          // bienvenida
          Swal.fire({icon:'success',title:`¡Hola, ${alumno.nombres.split(' ')[0]}!`,text:'Bienvenido al portal de entregas.',timer:1800,showConfirmButton:false});

          // NO mostrar "Mis envíos" automáticamente (queda oculto)
          stopPolling(); // no auto-poll
        }else{
          Swal.fire({icon:'error',title:'No autorizado',text:'La cédula no está registrada.'});
        }
      }catch{ Swal.fire({icon:'error',title:'Error de conexión',text:'Revisa la URL /exec.'}); }
    });

    $('btn-salir').addEventListener('click', async ()=>{
      const {isConfirmed} = await Swal.fire({icon:'question',title:'¿Cerrar sesión?',showCancelButton:true,confirmButtonText:'Sí',cancelButtonText:'No'});
      if(!isConfirmed) return;
      stopPolling();
      alumno=null; clearSession(); toggleViews(true); $('form-login').reset();
      // Oculta y limpia "Mis envíos"
      document.getElementById('envios-section').classList.add('hidden');
      $('envios-tbody').innerHTML=''; $('envios-count').textContent='0 registros'; $('pageInfo').textContent='1 / 1';
      $('searchEnvios').value='';
    });

    (function restore(){
      const s = loadSession(); if(!s) return;
      alumno = s;
      $('alumno-nombre').textContent=`${alumno.nombres} ${alumno.apellidos}`;
      $('alumno-cedula').textContent=alumno.cedula;
      toggleViews(false); renderSemanas(); refreshEjemplo();
      // Mantener "Mis envíos" oculto hasta que el usuario lo pida
      stopPolling();
    })();

    // Mostrar / ocultar "Mis envíos" a demanda (AJAX)
    $('btn-ver-envios').addEventListener('click', async (e)=>{
      e.preventDefault();
      if(!alumno) return;
      const sec = $('envios-section');
      sec.classList.remove('hidden');
      await cargarMisEnvios(true);
      sec.scrollIntoView({behavior:'smooth', block:'start'});
      // Si quieres activar polling cuando está visible, descomenta:
      // startPolling();
    });
    $('btn-cerrar-envios').addEventListener('click', ()=>{
      $('envios-section').classList.add('hidden');
      stopPolling();
    });

    /* ============ TIPO: INDIVIDUAL/GRUPAL/CURSO ============ */
    let allStudents = []; let groupSelected = new Set();
    const tipoRadios = () => [...document.querySelectorAll('input[name="tipoEntrega"]')];

    function showGrupoUI(show){
      $('grupo-container').classList.toggle('hidden', !show);
      if (!show) { groupSelected.clear(); updateChipTipo('INDIVIDUAL'); $('countSel').textContent='0 seleccionados'; }
      refreshEjemplo();
    }

    async function ensureStudentsLoaded(){
      if (allStudents.length) return;
      try {
        const r = await fetch(`${SCRIPT_URL}?action=students&t=${Date.now()}`);
        const j = await r.json();
        allStudents = (j.ok ? j.students : []).map(s => ({
          cedula: normId(s.cedula),
          nombres: s.nombres || '',
          apellidos: s.apellidos || ''
        })).sort((a,b)=> (a.apellidos+' '+a.nombres).localeCompare(b.apellidos+' '+b.nombres,'es'));
      } catch { allStudents = []; }
    }

    function paintStudents(filter=''){
      const cont = $('listaIntegrantes');
      const term = filter.toLowerCase().trim();
      const me = alumno ? normId(alumno.cedula) : '';
      const items = allStudents.filter(s => !term || s.cedula.includes(term) || (s.nombres+' '+s.apellidos).toLowerCase().includes(term));

      cont.innerHTML = items.map(s=>{
        const checked = groupSelected.has(s.cedula) || s.cedula===me;
        const disabled = s.cedula===me;
        return `<label class="flex items-center gap-3 rounded-lg border bg-white px-3 py-2 hover:bg-slate-50">
          <input type="checkbox" data-ced="${s.cedula}" class="accent-[var(--brand)]" ${checked?'checked':''} ${disabled?'disabled':''}>
          <span class="text-sm">${s.cedula} — ${s.apellidos} ${s.nombres}</span>
        </label>`;
      }).join('');

      cont.querySelectorAll('input[type="checkbox"]').forEach(cbx=>{
        cbx.addEventListener('change', (e)=>{
          const ced = e.target.dataset.ced;
          if (e.target.checked) groupSelected.add(ced); else groupSelected.delete(ced);
          $('countSel').textContent = `${groupSelected.size} seleccionados`;
          updateChipTipo('GRUPAL', groupSelected.size || 1);
          refreshEjemplo();
        });
      });

      if (me) { groupSelected.add(me); $('countSel').textContent = `${groupSelected.size} seleccionados`; }
      updateChipTipo('GRUPAL', groupSelected.size || 1);
      refreshEjemplo();
    }

    tipoRadios().forEach(r=>{
      r.addEventListener('change', async ()=>{
        const tipo = tipoRadios().find(x=>x.checked)?.value || 'INDIVIDUAL';
        if (tipo === 'GRUPAL'){
          showGrupoUI(true);
          await ensureStudentsLoaded(); paintStudents($('buscarIntegrante').value||'');
        } else {
          showGrupoUI(false);
          updateChipTipo(tipo);
        }
      });
    });
    $('buscarIntegrante').addEventListener('input', (e)=> paintStudents(e.target.value||''));

    /* ============ SUBIDA ============ */
    ['parcial','semana','materia','numeroTarea'].forEach(id=>{
      $(id).addEventListener(id==='numeroTarea'?'input':'change', ()=>{ refreshEjemplo(); touchSession(); });
    });

    $('form-upload').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!alumno) return Swal.fire({icon:'error',title:'Sesión',text:'Inicia sesión con tu cédula.'});

      const materia=$('materia').value, parcial=$('parcial').value, semana=$('semana').value, num=$('numeroTarea').value, file=$('archivo').files[0];
      let finalName=($('nombre-final').value||'').trim();
      const tipo = (tipoRadios().find(x=>x.checked)?.value || 'INDIVIDUAL').toUpperCase();

      if(!materia||!parcial||!semana||!num||!file) return Swal.fire({icon:'warning',title:'Campos incompletos',text:'Completa todos los campos.'});
      if (tipo === 'GRUPAL') {
        await ensureStudentsLoaded();
        const me = normId(alumno.cedula); groupSelected.add(me);
        if (groupSelected.size < 2) return Swal.fire({icon:'info',title:'Selecciona el grupo',text:'Elige al menos 2 integrantes (incluyéndote).'});
      }
      if(file.size>SIZE_LIMIT) return Swal.fire({icon:'error',title:'Archivo muy grande',text:'Límite 25 MB.'});

      // Base esperada (sin sufijo) y sugerida (con sufijo según tipo)
      const baseEsperada = nombreEsperadoBase(materia, semana, alumno?.nombres, alumno?.apellidos, num);
      const baseSugerida = baseEsperada + tipoSuffix(tipo);

      const ext=(file.name.match(/\.([^.]+)$/)||['','pdf'])[1];
      const baseFinal=finalName.replace(/\.[^.]+$/,'').trim();

      if(baseFinal!==baseSugerida){
        const { isConfirmed } = await Swal.fire({icon:'question',title:'Renombrar archivo',html:`El nombre sugerido es <code>${baseSugerida}</code>.<br><br>¿Deseas que el sistema lo aplique automáticamente?`,showCancelButton:true, confirmButtonText:'Sí, renombrar'});
        if(!isConfirmed) return;
        finalName = `${baseSugerida}.${ext}`;
        $('nombre-final').value = finalName;
      }else if(!/\.[^.]+$/.test(finalName)){
        finalName = `${baseFinal}.${ext}`; $('nombre-final').value = finalName;
      }

      Swal.showLoading(); touchSession();

      const base64 = await new Promise((ok,err)=>{ const fr=new FileReader(); fr.onload=()=>ok(String(fr.result).split(',')[1]); fr.onerror=err; fr.readAsDataURL(file); });

      try{
        const payload={
          action:'upload',
          cedula:alumno.cedula, materia:String(materia), parcial:String(parcial), semana:String(semana),
          numeroTarea:String(num).padStart(2,'0'), nombres:alumno.nombres, apellidos:alumno.apellidos,
          filename:finalName, mimeType:file.type, data:base64,
          tipo,
          groupMembers: (tipo==='GRUPAL') ? Array.from(groupSelected) : (tipo==='CURSO' ? ['ALL'] : [normId(alumno.cedula)])
        };
        const res = await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify(payload) });
        const data = await res.json().catch(()=>null);

        if(res.ok && data && data.ok){
          Swal.fire({icon:'success',title:'¡Enviado!',html:`Se subió correctamente.<br><a class="text-blue-600 underline" target="_blank" href="${data.fileUrl}">Ver en Drive</a>`});
          $('form-upload').reset(); currentExt=''; renderSemanas(); $('nombre-final').value='';
          document.querySelector('input[name="tipoEntrega"][value="INDIVIDUAL"]').checked = true;
          showGrupoUI(false); groupSelected.clear(); updateChipTipo('INDIVIDUAL');
          // No desplazar ni abrir "Mis envíos" automáticamente
        }else{
          Swal.fire({icon:'error',title:'Error',text:(data&&data.message)||`No se pudo subir. Estado ${res.status}`});
        }
      }catch{ Swal.fire({icon:'error',title:'Error de conexión',text:'Intenta nuevamente.'}); }
    });

    /* ============ LISTAR + POLLING (a demanda) ============ */
    async function cargarMisEnvios(showLoading=true){
      if(!alumno) return;
      try{
        if(showLoading) $('envios-loading').classList.remove('hidden');
        const url = `${SCRIPT_URL}?action=list&cedula=${encodeURIComponent(alumno.cedula)}&t=${Date.now()}`;
        const res = await fetch(url, { cache: 'no-store' });
        const data = await res.json().catch(()=>null);
        enviosData = (data && data.ok && Array.isArray(data.items)) ? data.items : [];
        applyFilterAndRender();
      }catch{
        enviosData = []; applyFilterAndRender();
      }finally{
        $('envios-loading').classList.add('hidden');
      }
    }
    function startPolling(){
      stopPolling();
      pollTimer = setInterval(()=>cargarMisEnvios(false), 30000);
      window.addEventListener('focus', onFocusReload);
    }
    function stopPolling(){
      if (pollTimer){ clearInterval(pollTimer); pollTimer=null; }
      window.removeEventListener('focus', onFocusReload);
    }
    function onFocusReload(){ const sec = $('envios-section'); if (!sec.classList.contains('hidden')) cargarMisEnvios(false); }

    function applyFilterAndRender(){
      const q = ($('searchEnvios').value||'').toLowerCase().trim();
      filtered = !q ? enviosData.slice() :
        enviosData.filter(r=>{
          const hay = [r.fecha, r.materia, r.parcial, r.semana, r.numeroTarea, r.filename, r.tipo, (r.grupoLabel||'')].map(x=>String(x||'').toLowerCase());
          return hay.some(v=>v.includes(q));
        });
      currentPage = 1; renderEnviosTable();
    }

    function tipoChip(tipo){
      const t = String(tipo||'').toUpperCase();
      if (t==='GRUPAL') return `<span class="chip chip-amber">Grupal</span>`;
      if (t==='CURSO')  return `<span class="chip chip-emerald">Curso</span>`;
      return `<span class="chip chip-indigo">Individual</span>`;
    }

    function grupoLabelFromField(grupo){
      // grupo puede venir como JSON string (["..."]) o "ALL" o vacío
      try {
        if (typeof grupo === 'string' && grupo.trim().startsWith('[')) {
          const arr = JSON.parse(grupo);
          const n = Array.isArray(arr) ? arr.length : 0;
          return n>0 ? `${n} integrante${n===1?'':'s'}` : '';
        }
      } catch {}
      if (grupo==='ALL' || (typeof grupo==='string' && grupo.toUpperCase()==='ALL')) return 'Todos';
      return ''; // individual
    }

    function renderEnviosTable(){
      const tbody=$('envios-tbody'); tbody.innerHTML='';
      const total = filtered.length;
      pageSize = parseInt($('pageSize').value || '10',10);
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(currentPage, totalPages);

      const start = (currentPage-1)*pageSize;
      const pageItems = filtered.slice(start, start+pageSize);

      if(pageItems.length===0){
        tbody.innerHTML = `<tr><td class="px-4 py-4 text-slate-500 italic" colspan="8">Sin envíos.</td></tr>`;
      }else{
        pageItems.forEach(r=>{
          const tr=document.createElement('tr');
          const gLabel = r.grupoLabel || grupoLabelFromField(r.grupo);
          tr.innerHTML=`
            <td class="px-4 py-2">${r.fecha||''}</td>
            <td class="px-4 py-2">${r.materia||''}</td>
            <td class="px-4 py-2">${r.parcial||''}</td>
            <td class="px-4 py-2">${r.semana||''}</td>
            <td class="px-4 py-2">${r.numeroTarea||''}</td>
            <td class="px-4 py-2">${tipoChip(r.tipo)}</td>
            <td class="px-4 py-2">${gLabel||''}</td>
            <td class="px-4 py-2">
              ${r.fileUrl ? `<a class="text-blue-600 underline" target="_blank" href="${r.fileUrl}">${r.filename||'Abrir'}</a>` : (r.filename||'')}
            </td>`;
          tbody.appendChild(tr);
        });
      }

      $('envios-count').textContent = `${total} registro${total===1?'':'s'}`;
      $('pageInfo').textContent = `${total===0?0:currentPage} / ${totalPages}`;
      $('firstPage').disabled = currentPage<=1; $('prevPage').disabled  = currentPage<=1;
      $('nextPage').disabled  = currentPage>=totalPages; $('lastPage').disabled  = currentPage>=totalPages;
    }

    // Controles tabla
    $('searchEnvios').addEventListener('input', ()=>applyFilterAndRender());
    $('pageSize').addEventListener('change', ()=>{ currentPage=1; renderEnviosTable(); });
    $('firstPage').addEventListener('click', ()=>{ currentPage=1; renderEnviosTable(); });
    $('prevPage').addEventListener('click',  ()=>{ if(currentPage>1) currentPage--; renderEnviosTable(); });
    $('nextPage').addEventListener('click',  ()=>{ currentPage++; renderEnviosTable(); });
    $('lastPage').addEventListener('click',  ()=>{
      const totalPages = Math.max(1, Math.ceil(filtered.length / parseInt($('pageSize').value,10)));
      currentPage = totalPages; renderEnviosTable();
    });
  </script>
</body>
</html>
