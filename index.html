<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Estudiantes</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root { --brand:#2F338F; }
    html,body{height:100%}
    body{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    .card{box-shadow:0 20px 60px rgba(0,0,0,.08)}
    input,select{ outline:none }
    input:focus,select:focus{ border-color:var(--brand) !important; box-shadow:0 0 0 6px rgba(47,51,143,.13) }
    .logo-row img{ height:48px; width:auto; object-fit:contain }
    code{ background:#eef2ff; padding:.1rem .3rem; border-radius:.4rem }
    .chip{ @apply inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-indigo-50 text-slate-800">

  <!-- Sección superior (info izquierda + formulario derecha) -->
  <div class="min-h-[70vh] grid grid-cols-1 lg:grid-cols-2">
    <!-- Izquierda -->
    <aside class="hidden lg:flex flex-col justify-center bg-gradient-to-b from-white via-indigo-50 to-slate-50 text-slate-800 p-10">
      <div class="max-w-lg mx-auto w-full">
        <div class="flex items-center gap-4 mb-8 logo-row">
          <img src="assets/ueb.png" alt="UEB" />
          <img src="assets/rrd.png" alt="Carrera" />
        </div>
        <h1 class="text-3xl font-semibold leading-tight">Gestión de Estudiantes</h1>
        <p class="mt-3 text-slate-600">Portal para subir tareas por semanas y parciales. Acceso por número de cédula.</p>
        <ul class="mt-6 space-y-2 text-slate-700 text-sm">
          <li>• Parciales: 1 y 2</li>
          <li>• Validación de nombre de archivo</li>
          <li>• Registro automático en Google Sheets y Drive</li>
          <li>• Tareas <b>Individuales / Grupales / Curso</b></li>
        </ul>
      </div>
    </aside>

    <!-- Derecha -->
    <main class="flex items-center justify-center p-6">
      <div class="w-full max-w-2xl">
        <div class="card bg-white rounded-2xl p-6 md:p-8">

          <div class="flex lg:hidden items-center gap-4 mb-6 logo-row">
            <img src="assets/ueb.png" alt="UEB" />
            <img src="assets/rrd.png" alt="Carrera" />
          </div>

          <!-- ========== LOGIN ========== -->
          <section id="view-login" class="space-y-6">
            <header>
              <h2 class="text-2xl md:text-3xl font-semibold">Ingreso por cédula</h2>
              <p class="text-slate-600 mt-1">Ingresa tu número de cédula para acceder al panel.</p>
            </header>

            <form id="form-login" class="space-y-3">
              <div>
                <label for="cedula" class="block text-sm font-medium text-slate-700 mb-1">Número de cédula</label>
                <input id="cedula" name="cedula" inputmode="numeric"
                       pattern="^(\d{10}|\d{13})$" maxlength="13"
                       placeholder="Ej: 0102030405"
                       class="w-full rounded-xl border border-slate-300 px-4 py-3" required>
                <p class="text-xs text-slate-500 mt-1">* Debe estar registrado en la base de datos.</p>
              </div>
              <div class="flex justify-end">
                <button type="submit"
                        class="inline-flex justify-center items-center rounded-xl bg-[var(--brand)] text-white px-6 py-3 font-semibold hover:opacity-95 active:opacity-90 transition">
                  Acceder
                </button>
              </div>
            </form>
          </section>

          <!-- ========== PANEL (FORMULARIO) ========== -->
          <section id="view-panel" class="hidden space-y-4">
            <div class="flex items-center justify-between gap-4 flex-wrap">
              <div>
                <h2 class="text-2xl md:text-3xl font-semibold">Bienvenido</h2>
                <p class="text-slate-600">
                  <span id="alumno-nombre" class="font-semibold"></span> &middot;
                  Cédula: <span id="alumno-cedula" class="font-mono"></span>
                </p>
              </div>
              <div class="flex gap-2">
                <a href="#envios-section" class="text-sm text-[var(--brand)] underline">Ver mis envíos</a>
                <button id="btn-salir" class="text-sm text-slate-600 hover:text-red-600">Salir</button>
              </div>
            </div>

            <!-- FORM -->
            <form id="form-upload" class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Materia -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-1">Materia</label>
                <select id="materia" class="w-full rounded-xl border border-slate-300 px-4 py-3" required>
                  <option value="" disabled selected>Selecciona</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">* Se usará para la carpeta en Drive.</p>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Parcial</label>
                <select id="parcial" class="w-full rounded-xl border border-slate-300 px-4 py-3" required>
                  <option value="" disabled selected>Selecciona</option>
                  <option value="1">Parcial 1</option>
                  <option value="2">Parcial 2</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Semana</label>
                <select id="semana" class="w-full rounded-xl border border-slate-300 px-4 py-3" required>
                  <option value="" disabled selected>Selecciona</option>
                </select>
              </div>

              <!-- Tipo de entrega -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-1">Tipo de entrega</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <label class="flex items-center gap-2 rounded-xl border px-4 py-3 hover:bg-slate-50 cursor-pointer">
                    <input type="radio" name="tipoEntrega" value="INDIVIDUAL" class="accent-[var(--brand)]" checked>
                    <span>Individual</span>
                  </label>
                  <label class="flex items-center gap-2 rounded-xl border px-4 py-3 hover:bg-slate-50 cursor-pointer">
                    <input type="radio" name="tipoEntrega" value="GRUPAL" class="accent-[var(--brand)]">
                    <span>Grupal</span>
                  </label>
                  <label class="flex items-center gap-2 rounded-xl border px-4 py-3 hover:bg-slate-50 cursor-pointer">
                    <input type="radio" name="tipoEntrega" value="CURSO" class="accent-[var(--brand)]">
                    <span>Curso</span>
                  </label>
                </div>
                <p class="text-xs text-slate-500 mt-1">En grupal selecciona a tus integrantes; en curso no es necesario (un envío por curso).</p>
              </div>

              <!-- Integrantes (solo GRUPAL) -->
              <div id="grupo-container" class="md:col-span-2 hidden">
                <div class="rounded-xl border border-slate-200 p-4 bg-slate-50">
                  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div class="font-medium">Integrantes del grupo</div>
                    <div class="flex items-center gap-2">
                      <input id="buscarIntegrante" placeholder="Buscar por cédula o nombre..." class="rounded-lg border border-slate-300 px-3 py-2 text-sm w-64">
                      <span class="text-xs text-slate-500" id="countSel">0 seleccionados</span>
                    </div>
                  </div>
                  <div id="listaIntegrantes" class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2 max-h-64 overflow-auto pr-1"></div>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">N.º de tarea</label>
                <input id="numeroTarea" type="number" min="1" max="99" placeholder="01"
                       class="w-full rounded-xl border border-slate-300 px-4 py-3" required>
                <p class="text-xs text-slate-500 mt-1">Usa 01, 02, 03…</p>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Archivo</label>
                <input id="archivo" type="file" class="w-full rounded-xl border border-slate-300 px-4 py-2 bg-white" required>
                <p class="text-xs text-slate-500 mt-1">Formatos: PDF, DOCX, PPTX, XLSX, JPG, PNG (≤ 25 MB)</p>
              </div>

              <!-- Renombrado -->
              <div class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl p-4 space-y-2">
                <p class="text-sm">
                  Nombre sugerido:
                  <code class="font-mono text-[var(--brand)]" id="nombre-ejemplo">ABBR_SEMANA_1_NOMBRE_APELLIDO_01</code>
                </p>
                <div class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2 items-center">
                  <div>
                    <label class="block text-xs text-slate-500 mb-1">Nombre final</label>
                    <input id="nombre-final" type="text" class="w-full rounded-lg border border-slate-300 px-3 py-2 font-mono" placeholder="Selecciona un archivo para sugerir la extensión">
                  </div>
                  <button id="btn-aplicar-nombre" type="button" class="text-sm px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">Aplicar sugerido</button>
                </div>
                <p class="text-xs text-slate-500">Si no coincide el formato, te proponemos renombrar antes de enviar.</p>
              </div>

              <div class="md:col-span-2 flex justify-end gap-3 mt-2">
                <button type="reset" class="px-5 py-3 rounded-xl border border-slate-300">Limpiar</button>
                <button type="submit" class="px-5 py-3 rounded-xl bg-[var(--brand)] text-white font-semibold hover:opacity-95 active:opacity-90">
                  Subir
                </button>
              </div>
            </form>
          </section>

        </div>
      </div>
    </main>
  </div>

  <!-- ========== MIS ENVIOS ========== -->
  <section id="envios-section" class="px-6 py-10 hidden">
    <div class="max-w-5xl mx-auto card bg-white rounded-2xl p-6 md:p-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <h3 class="text-2xl font-semibold">Mis envíos</h3>
        <div class="flex gap-3 items-center">
          <input id="searchEnvios" class="rounded-lg border border-slate-300 px-3 py-2 text-sm" placeholder="Buscar...">
          <label class="text-sm text-slate-600">Por página
            <select id="pageSize" class="ml-2 rounded-md border border-slate-300 px-2 py-1 text-sm">
              <option>10</option><option>25</option><option>50</option><option>100</option>
            </select>
          </label>
        </div>
      </div>

      <div class="overflow-x-auto rounded-xl border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="text-left px-4 py-2">Fecha</th>
              <th class="text-left px-4 py-2">Materia</th>
              <th class="text-left px-4 py-2">Parcial</th>
              <th class="text-left px-4 py-2">Semana</th>
              <th class="text-left px-4 py-2">Tarea</th>
              <th class="text-left px-4 py-2">Archivo</th>
            </tr>
          </thead>
          <tbody id="envios-tbody"></tbody>
        </table>
      </div>

      <div class="flex items-center justify-between mt-3 text-sm">
        <div id="envios-count" class="text-slate-600">0 registros</div>
        <div class="flex gap-2">
          <button id="firstPage" class="px-3 py-1 rounded border border-slate-300">«</button>
          <button id="prevPage"  class="px-3 py-1 rounded border border-slate-300">‹</button>
          <span id="pageInfo" class="px-2">1 / 1</span>
          <button id="nextPage"  class="px-3 py-1 rounded border border-slate-300">›</button>
          <button id="lastPage" class="px-3 py-1 rounded border border-slate-300">»</button>
        </div>
      </div>
    </div>
  </section>

  <script>
    /* ============ CONFIG ============ */
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzMWfuwghGGXh652PYLHfFH54HM-8S5T3IS7TyXTOXfrp2v3uZCdYyUTdYWvVXbax6-/exec';
    const SEMANAS_POR_PARCIAL = 15;
    const SIZE_LIMIT = 25 * 1024 * 1024;

    const TIPOS_PERMITIDOS = [
      'application/pdf','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/msword',
      'application/vnd.openxmlformats-officedocument.presentationml.presentation','application/vnd.ms-powerpoint',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','application/vnd.ms-excel','image/jpeg','image/png'
    ];

    // Materias/abreviaturas (debe coincidir con backend)
    const MATERIAS = [
      'Marco Legal para la Gestión del Riesgo',
      'Administración',
      'Sistemas de Información Geográfica Aplicado',
      'Evaluación de Amenazas',
      'Evaluación de Vulnerabilidades',
      'Cambio Climático'
    ];
    const MATERIA_ABBR = {
      'Marco Legal para la Gestión del Riesgo': 'MLGR',
      'Administración': 'ADM',
      'Sistemas de Información Geográfica Aplicado': 'SIG',
      'Evaluación de Amenazas': 'EA',
      'Evaluación de Vulnerabilidades': 'EV',
      'Cambio Climático': 'CC'
    };

    /* ============ SESIÓN ============ */
    const SESSION_KEY = 'sesionAlumno';
    const SESSION_TTL_MIN = 180; // 3 horas
    const now = ()=>Date.now();

    const saveSession = (student)=> localStorage.setItem(SESSION_KEY, JSON.stringify({ student, ts: now() }));
    const loadSession = ()=>{
      try{
        const raw = localStorage.getItem(SESSION_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || !obj.student) return null;
        const ageMin = (now() - (obj.ts||0)) / 60000;
        if(ageMin > SESSION_TTL_MIN) { localStorage.removeItem(SESSION_KEY); return null; }
        return obj.student;
      }catch{ return null; }
    };
    const touchSession = ()=>{
      try{
        const raw = localStorage.getItem(SESSION_KEY);
        if(!raw) return;
        const obj = JSON.parse(raw); obj.ts = now();
        localStorage.setItem(SESSION_KEY, JSON.stringify(obj));
      }catch{}
    };
    const clearSession = ()=> localStorage.removeItem(SESSION_KEY);

    /* ============ HELPERS ============ */
    const $ = (id)=>document.getElementById(id);
    const sinAcentos=(s)=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const slugUpper=(s)=>sinAcentos(String(s||'').trim()).replace(/[^A-Za-z\s]/g,'').replace(/\s+/g,'_').toUpperCase();
    const pad2=(n)=>String(n).padStart(2,'0');
    const getExt=(name)=>{ const m = String(name).match(/\.([^.]+)$/); return m? m[1] : ''; };

    const abbr=(materia)=> MATERIA_ABBR[materia] || 'ABBR';
    const nombreEsperado=(materia,semana,nombres,apellidos,num)=>{
      const nom=slugUpper(nombres.split(' ')[0]||'NOMBRE');
      const ape=slugUpper(apellidos.split(' ')[0]||'APELLIDO');
      return `${abbr(materia)}_SEMANA_${semana}_${nom}_${ape}_${pad2(num)}`
    };

    const toggleViews=(showLogin)=>{
      $('view-login').classList.toggle('hidden',!showLogin);
      $('view-panel').classList.toggle('hidden',showLogin);
    };

    const normId = (x)=> String(x||'').replace(/\D/g,'').replace(/^0+/, '') || '0';

    /* ====== Validador EC (cédula/RUC) ====== */
    function validarCedulaEC(ced) {
      if (!/^\d{10}$/.test(ced)) return false;
      const prov = parseInt(ced.slice(0,2),10);
      if (prov < 1 || prov > 24) return false;
      const d = ced.split('').map(n=>parseInt(n,10));
      const coef = [2,1,2,1,2,1,2,1,2];
      let suma = 0;
      for (let i=0;i<9;i++){
        let prod = d[i]*coef[i];
        if (prod >= 10) prod -= 9;
        suma += prod;
      }
      const mod = suma % 10;
      const verificador = (mod === 0) ? 0 : 10 - mod;
      return verificador === d[9];
    }
    function validarIdentificacionEC(ident){
      if (/^\d{10}$/.test(ident)) return validarCedulaEC(ident);
      if (/^\d{13}$/.test(ident)) return validarCedulaEC(ident.slice(0,10));
      return false;
    }

    /* ============ ESTADO ENVIOS ============ */
    let alumno=null;
    let currentExt='';
    let enviosData = [];
    let filtered = [];
    let pageSize = 10;
    let currentPage = 1;

    // Pinta materias
    (function fillMaterias(){
      const sel = $('materia');
      MATERIAS.forEach(m=>{
        const op = document.createElement('option');
        op.value = m; op.textContent = m;
        sel.appendChild(op);
      });
    })();

    const renderSemanas=()=>{
      const parcial=$('parcial').value;
      const sel=$('semana');
      sel.innerHTML='<option value="" disabled selected>Selecciona</option>';
      if(!parcial) return;
      for(let i=1;i<=SEMANAS_POR_PARCIAL;i++){
        const op=document.createElement('option');
        op.value=String(i); op.textContent=`Semana ${i}`;
        sel.appendChild(op);
      }
    };

    const refreshEjemplo=()=>{
      const materia=$('materia').value || '';
      const semana=$('semana').value||'1';
      const num=$('numeroTarea').value||'1';
      const ejemplo=nombreEsperado(materia, semana, alumno?.nombres||'NOMBRE', alumno?.apellidos||'APELLIDO', num);
      $('nombre-ejemplo').textContent=ejemplo;
      if(currentExt){ $('nombre-final').placeholder = `${ejemplo}.${currentExt}`; }
    };

    $('btn-aplicar-nombre')?.addEventListener('click', ()=>{
      const base = $('nombre-ejemplo').textContent.trim();
      const ext = currentExt || 'pdf';
      $('nombre-final').value = `${base}.${ext}`;
    });

    $('archivo').addEventListener('change', ()=>{
      const f = $('archivo').files[0];
      if(!f){ currentExt=''; return; }
      currentExt = getExt(f.name) || currentExt || 'pdf';
      const base = $('nombre-ejemplo').textContent.trim();
      $('nombre-final').value = `${base}.${currentExt}`;
      $('nombre-final').placeholder = `${base}.${currentExt}`;
    });

    /* ============ LOGIN ============ */
    $('form-login').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const cedula=$('cedula').value.trim();
      if(!cedula) return;

      if (!validarIdentificacionEC(cedula)) {
        return Swal.fire({icon:'warning',title:'Número inválido',text:'Revisa tu cédula (10) o RUC (13).'});
      }

      Swal.showLoading();
      try{
        const res = await fetch(`${SCRIPT_URL}?action=auth&cedula=${encodeURIComponent(cedula)}`);
        const data = await res.json();
        if(data.ok){
          alumno=data.student;
          saveSession(alumno);
          $('alumno-nombre').textContent=`${alumno.nombres} ${alumno.apellidos}`;
          $('alumno-cedula').textContent=alumno.cedula;
          toggleViews(false); renderSemanas(); refreshEjemplo(); Swal.close();
          document.getElementById('envios-section').classList.remove('hidden');
          cargarMisEnvios();
        }else{
          Swal.fire({icon:'error',title:'No autorizado',text:'La cédula no está registrada.'});
        }
      }catch(err){
        Swal.fire({icon:'error',title:'Error de conexión',text:'Revisa la URL /exec.'});
      }
    });

    $('parcial').addEventListener('change', ()=>{renderSemanas(); refreshEjemplo(); touchSession();});
    $('semana').addEventListener('change', ()=>{refreshEjemplo(); touchSession();});
    $('materia').addEventListener('change', ()=>{refreshEjemplo(); touchSession();});
    $('numeroTarea').addEventListener('input', ()=>{refreshEjemplo(); touchSession();});

    $('btn-salir').addEventListener('click', ()=>{
      alumno=null; clearSession(); toggleViews(true); $('form-login').reset();
      document.getElementById('envios-section').classList.add('hidden');
      $('envios-tbody').innerHTML=''; $('envios-count').textContent='0 registros'; $('pageInfo').textContent='1 / 1';
    });

    // Restaurar sesión al cargar
    (function restore(){
      const s = loadSession();
      if(!s) return;
      alumno = s;
      $('alumno-nombre').textContent=`${alumno.nombres} ${alumno.apellidos}`;
      $('alumno-cedula').textContent=alumno.cedula;
      toggleViews(false); renderSemanas(); refreshEjemplo();
      document.getElementById('envios-section').classList.remove('hidden');
      cargarMisEnvios();
    })();

    /* ============ TIPO: INDIVIDUAL/GRUPAL/CURSO ============ */
    let allStudents = [];         // {cedula, nombres, apellidos}
    let groupSelected = new Set();// cédulas normalizadas
    const tipoRadios = () => [...document.querySelectorAll('input[name="tipoEntrega"]')];

    function showGrupoUI(show){
      $('grupo-container').classList.toggle('hidden', !show);
      if (!show) {
        groupSelected.clear();
        updateCountSel();
      }
    }

    async function ensureStudentsLoaded(){
      if (allStudents.length) return;
      try {
        const r = await fetch(`${SCRIPT_URL}?action=students&t=${Date.now()}`);
        const j = await r.json();
        allStudents = (j.ok ? j.students : []).map(s => ({
          cedula: normId(s.cedula),
          nombres: s.nombres || '',
          apellidos: s.apellidos || ''
        })).sort((a,b)=> (a.apellidos+' '+a.nombres).localeCompare(b.apellidos+' '+b.nombres,'es'));
      } catch { allStudents = []; }
    }

    function paintStudents(filter=''){
      const cont = $('listaIntegrantes');
      const term = filter.toLowerCase().trim();
      const me = alumno ? normId(alumno.cedula) : '';
      const items = allStudents.filter(s => {
        if (s.cedula === me) return true; // que el propio alumno se vea primero
        if (!term) return true;
        return s.cedula.includes(term) || (s.nombres+' '+s.apellidos).toLowerCase().includes(term);
      });

      cont.innerHTML = items.map(s=>{
        const checked = groupSelected.has(s.cedula) || s.cedula===me;
        const disabled = s.cedula===me; // el que sube siempre va
        return `<label class="flex items-center gap-3 rounded-lg border bg-white px-3 py-2 hover:bg-slate-50">
          <input type="checkbox" data-ced="${s.cedula}" class="accent-[var(--brand)]" ${checked?'checked':''} ${disabled?'disabled':''}>
          <span class="text-sm">${s.cedula} — ${s.apellidos} ${s.nombres}</span>
        </label>`;
      }).join('');

      // listeners
      cont.querySelectorAll('input[type="checkbox"]').forEach(cbx=>{
        cbx.addEventListener('change', (e)=>{
          const ced = e.target.dataset.ced;
          if (e.target.checked) groupSelected.add(ced); else groupSelected.delete(ced);
          updateCountSel();
        });
      });

      // asegurar incluir al propio alumno
      if (me) groupSelected.add(me);
      updateCountSel();
    }

    function updateCountSel(){
      $('countSel').textContent = `${groupSelected.size} seleccionados`;
    }

    // Wiring de tipo
    tipoRadios().forEach(r=>{
      r.addEventListener('change', async ()=>{
        const tipo = tipoRadios().find(x=>x.checked)?.value || 'INDIVIDUAL';
        if (tipo === 'GRUPAL'){
          showGrupoUI(true);
          await ensureStudentsLoaded();
          paintStudents($('buscarIntegrante').value||'');
        } else {
          showGrupoUI(false);
        }
      });
    });
    $('buscarIntegrante').addEventListener('input', (e)=> paintStudents(e.target.value||''));

    /* ============ SUBIDA ============ */
    $('form-upload').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!alumno) return Swal.fire({icon:'error',title:'Sesión',text:'Inicia sesión con tu cédula.'});

      const materia=$('materia').value;
      const parcial=$('parcial').value;
      const semana=$('semana').value;
      const num=$('numeroTarea').value;
      const file=$('archivo').files[0];
      let finalName=($('nombre-final').value||'').trim();

      const tipo = (tipoRadios().find(x=>x.checked)?.value || 'INDIVIDUAL').toUpperCase();

      if(!materia||!parcial||!semana||!num||!file)
        return Swal.fire({icon:'warning',title:'Campos incompletos',text:'Completa todos los campos.'});

      if (tipo === 'GRUPAL') {
        await ensureStudentsLoaded();
        // el propio alumno siempre incluido
        const me = normId(alumno.cedula);
        groupSelected.add(me);
        if (groupSelected.size < 2) {
          return Swal.fire({icon:'info',title:'Selecciona el grupo',text:'Elige al menos 2 integrantes (incluyéndote).'});
        }
      }

      if(file.size>SIZE_LIMIT)
        return Swal.fire({icon:'error',title:'Archivo muy grande',text:'Límite 25 MB.'});

      if(!TIPOS_PERMITIDOS.includes(file.type))
        return Swal.fire({icon:'warning',title:'Formato no permitido',text:'Sube PDF/DOCX/PPTX/XLSX/JPG/PNG.'});

      const esperado=$('nombre-ejemplo').textContent.trim();
      const ext=(file.name.match(/\.([^.]+)$/)||['','pdf'])[1];
      const baseFinal=finalName.replace(/\.[^.]+$/,'').trim();

      if(baseFinal!==esperado){
        const { isConfirmed } = await Swal.fire({
          icon:'question',
          title:'Renombrar archivo',
          html:`El nombre debe ser <code>${esperado}</code>.<br><br>¿Deseas que el sistema lo renombre automáticamente antes de enviar?`,
          showCancelButton:true, confirmButtonText:'Sí, renombrar', cancelButtonText:'Cancelar'
        });
        if(!isConfirmed) return;
        finalName = `${esperado}.${ext}`;
        $('nombre-final').value = finalName;
      }else if(!/\.[^.]+$/.test(finalName)){
        finalName = `${baseFinal}.${ext}`;
        $('nombre-final').value = finalName;
      }

      Swal.showLoading();
      touchSession();

      const base64 = await new Promise((ok,err)=>{
        const fr=new FileReader();
        fr.onload=()=>ok(String(fr.result).split(',')[1]);
        fr.onerror=err;
        fr.readAsDataURL(file);
      });

      try{
        const payload={
          action:'upload',
          cedula:alumno.cedula,
          materia:String(materia),
          parcial:String(parcial),
          semana:String(semana),
          numeroTarea:String(num).padStart(2,'0'),
          nombres:alumno.nombres,
          apellidos:alumno.apellidos,
          filename:finalName,
          mimeType:file.type,
          data:base64,
          // NUEVO:
          tipo, // INDIVIDUAL | GRUPAL | CURSO
          groupMembers: (tipo==='GRUPAL') ? Array.from(groupSelected) : (tipo==='CURSO' ? ['ALL'] : [normId(alumno.cedula)])
        };

        const res = await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify(payload) });
        const data = await res.json().catch(()=>null);

        if(res.ok && data && data.ok){
          Swal.fire({icon:'success',title:'¡Enviado!',html:`Se subió correctamente.<br><a class="text-blue-600 underline" target="_blank" href="${data.fileUrl}">Ver en Drive</a>`});
          $('form-upload').reset(); currentExt=''; renderSemanas(); $('nombre-final').value='';
          // reset tipo/ grupo
          document.querySelector('input[name="tipoEntrega"][value="INDIVIDUAL"]').checked = true;
          showGrupoUI(false); groupSelected.clear(); updateCountSel();
          cargarMisEnvios(); touchSession();
          document.getElementById('envios-section').scrollIntoView({behavior:'smooth'});
        }else{
          Swal.fire({icon:'error',title:'Error',text:(data&&data.message)||`No se pudo subir. Estado ${res.status}`});
        }
      }catch(err){
        Swal.fire({icon:'error',title:'Error de conexión',text:'Intenta nuevamente.'});
      }
    });

    /* ============ LISTAR + BUSCADOR + PAGINACIÓN ============ */
    async function cargarMisEnvios(){
      if(!alumno) return;
      try{
        const url = `${SCRIPT_URL}?action=list&cedula=${encodeURIComponent(alumno.cedula)}&t=${Date.now()}`;
        const res = await fetch(url, { cache: 'no-store' });
        const data = await res.json().catch(()=>null);
        enviosData = (data && data.ok && Array.isArray(data.items)) ? data.items : [];
        applyFilterAndRender();
      }catch(err){
        enviosData = [];
        applyFilterAndRender();
      }
    }

    function applyFilterAndRender(){
      const q = ($('searchEnvios').value||'').toLowerCase().trim();
      filtered = !q ? enviosData.slice() :
        enviosData.filter(r=>{
          const hay = [r.fecha, r.materia, r.parcial, r.semana, r.numeroTarea, r.filename].map(x=>String(x||'').toLowerCase());
          return hay.some(v=>v.includes(q));
        });
      currentPage = 1;
      renderEnviosTable();
    }

    function renderEnviosTable(){
      const tbody=$('envios-tbody');
      tbody.innerHTML='';
      const total = filtered.length;
      pageSize = parseInt($('pageSize').value || '10',10);
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(currentPage, totalPages);

      const start = (currentPage-1)*pageSize;
      const pageItems = filtered.slice(start, start+pageSize);

      if(pageItems.length===0){
        tbody.innerHTML = `<tr><td class="px-4 py-4 text-slate-500 italic" colspan="6">Sin envíos.</td></tr>`;
      }else{
        pageItems.forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td class="px-4 py-2">${r.fecha||''}</td>
            <td class="px-4 py-2">${r.materia||''}</td>
            <td class="px-4 py-2">${r.parcial||''}</td>
            <td class="px-4 py-2">${r.semana||''}</td>
            <td class="px-4 py-2">${r.numeroTarea||''}</td>
            <td class="px-4 py-2">
              ${r.fileUrl ? `<a class="text-blue-600 underline" target="_blank" href="${r.fileUrl}">${r.filename||'Abrir'}</a>` : (r.filename||'')}
            </td>`;
          tbody.appendChild(tr);
        });
      }

      $('envios-count').textContent = `${total} registro${total===1?'':'s'}`;
      $('pageInfo').textContent = `${total===0?0:currentPage} / ${totalPages}`;

      $('firstPage').disabled = currentPage<=1;
      $('prevPage').disabled  = currentPage<=1;
      $('nextPage').disabled  = currentPage>=totalPages;
      $('lastPage').disabled  = currentPage>=totalPages;
    }

    // Controles tabla
    $('searchEnvios').addEventListener('input', ()=>applyFilterAndRender());
    $('pageSize').addEventListener('change', ()=>{ currentPage=1; renderEnviosTable(); });
    $('firstPage').addEventListener('click', ()=>{ currentPage=1; renderEnviosTable(); });
    $('prevPage').addEventListener('click',  ()=>{ if(currentPage>1) currentPage--; renderEnviosTable(); });
    $('nextPage').addEventListener('click',  ()=>{ currentPage++; renderEnviosTable(); });
    $('lastPage').addEventListener('click',  ()=>{
      const totalPages = Math.max(1, Math.ceil(filtered.length / parseInt($('pageSize').value,10)));
      currentPage = totalPages; renderEnviosTable();
    });
  </script>
</body>
</html>
