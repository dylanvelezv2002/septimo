<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel Admin • Séptimo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{background:rgba(255,255,255,.85);backdrop-filter:blur(8px)}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/70 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Panel Admin</h1>
      <div id="adminBadge" class="hidden items-center gap-3">
        <span class="px-3 py-1 rounded-full bg-emerald-100 text-emerald-800 text-sm">Admin activo</span>
        <button id="logoutBtn" class="px-3 py-2 rounded-lg border hover:bg-slate-50">Salir</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6">
    <!-- LOGIN -->
    <section id="loginSection" class="card rounded-2xl shadow p-8 max-w-xl mx-auto">
      <h2 class="text-xl font-semibold mb-2">Acceso administrador</h2>
      <p class="text-slate-600 mb-6">Ingresa la clave guardada en <span class="font-mono">ADMIN_KEY</span> (Propiedades del Script).</p>
      <div class="space-y-4">
        <input id="adminKey" type="password" class="w-full border rounded-xl px-4 py-3 outline-none focus:ring-2 ring-slate-300" placeholder="ADMIN_KEY">
        <button id="loginBtn" class="w-full px-4 py-3 rounded-xl bg-slate-900 text-white hover:opacity-90">Entrar</button>
        <p id="loginMsg" class="text-sm text-red-600 hidden"></p>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashSection" class="hidden space-y-6">
      <!-- KPIs -->
      <div class="grid md:grid-cols-4 gap-4">
        <div class="card rounded-2xl shadow p-6">
          <p class="text-slate-500">Envíos</p>
          <p id="kpiEnvios" class="text-3xl font-semibold">—</p>
        </div>
        <div class="card rounded-2xl shadow p-6">
          <p class="text-slate-500">Estudiantes activos</p>
          <p id="kpiActivos" class="text-3xl font-semibold">—</p>
        </div>
        <div class="card rounded-2xl shadow p-6">
          <p class="text-slate-500">Materias</p>
          <p id="kpiMaterias" class="text-3xl font-semibold">—</p>
        </div>
        <div class="card rounded-2xl shadow p-6">
          <p class="text-slate-500">Últimas 24h</p>
          <p id="kpi24" class="text-3xl font-semibold">—</p>
        </div>
      </div>

      <!-- Filtros faltantes / enviados -->
      <div class="card rounded-2xl shadow p-6">
        <div class="flex flex-wrap items-end gap-3">
          <div class="grow">
            <label class="block text-sm text-slate-600 mb-1">Materia</label>
            <select id="fltMateria" class="w-full border rounded-xl px-3 py-2">
              <option value="">(Todas)</option>
              <option>Marco Legal para la Gestión del Riesgo</option>
              <option>Administración</option>
              <option>Sistemas de Información Geográfica Aplicado</option>
              <option>Evaluación de Amenazas</option>
              <option>Evaluación de Vulnerabilidades</option>
              <option>Cambio Climático</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Parcial</label>
            <select id="fltParcial" class="border rounded-xl px-3 py-2">
              <option value="">—</option>
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Semana</label>
            <input id="fltSemana" type="number" min="1" class="w-28 border rounded-xl px-3 py-2" placeholder="1">
          </div>
          <button id="btnFaltantes" class="px-4 py-2 rounded-xl border hover:bg-slate-50">Ver faltantes</button>
          <a id="btnCarpeta" target="_blank" class="px-4 py-2 rounded-xl border hover:bg-slate-50 hidden">Abrir carpeta</a>
        </div>

        <p id="faltSummary" class="mt-3 text-slate-600"></p>

        <!-- Leyenda -->
        <div class="mt-2 flex items-center gap-3 text-sm">
          <span class="inline-flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full bg-red-500"></span> Faltante</span>
          <span class="inline-flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full bg-emerald-500"></span> Enviado</span>
        </div>

        <div id="faltList" class="mt-3 grid sm:grid-cols-2 md:grid-cols-3 gap-2"></div>
      </div>

      <!-- Tabla registros -->
      <div class="card rounded-2xl shadow p-6">
        <div class="flex items-center justify-between gap-3 mb-4">
          <h3 class="text-lg font-semibold">Registros</h3>
          <div class="flex items-center gap-2">
            <input id="filterInput" class="border rounded-xl px-3 py-2" placeholder="Filtrar...">
            <button id="refreshBtn" class="px-3 py-2 rounded-xl border hover:bg-slate-50">Actualizar</button>
            <button id="exportBtn" class="px-3 py-2 rounded-xl border hover:bg-slate-50">Exportar CSV</button>
          </div>
        </div>
        <div class="overflow-auto">
          <table id="dataTable" class="min-w-full text-sm">
            <thead class="bg-slate-50 text-slate-600"></thead>
            <tbody class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
  /*********** CONFIG ***********/
  // PEGA AQUÍ tu URL de Apps Script (termina en /exec)
  const API_BASE = 'https://script.google.com/macros/s/AKfycbzMWfuwghGGXh652PYLHfFH54HM-8S5T3IS7TyXTOXfrp2v3uZCdYyUTdYWvVXbax6-/exec'; // <-- CAMBIAR

  /*********** STATE ***********/
  const state = { key: sessionStorage.getItem('ADMIN_KEY') || '' };

  /*********** UTILS ***********/
  const $ = s => document.querySelector(s);
  const show = (el, v=true) => el.classList.toggle('hidden', !v);
  const q = o => new URLSearchParams(o).toString();
  const normId = x => String(x||'').replace(/\D/g,'').replace(/^0+/, '') || '0';

  async function apiGet(params){
    const url = `${API_BASE}?${q(params)}`;
    const res = await fetch(url, { method:'GET', mode:'cors' });
    const json = await res.json().catch(()=> ({}));
    if (!res.ok || json.ok === false) throw new Error(json.message || 'Error de API');
    return json;
  }

  function renderTable(headers, rows){
    const thead = $('#dataTable thead');
    const tbody = $('#dataTable tbody');
    thead.innerHTML = '<tr>'+headers.map(h=>`<th class="text-left px-3 py-2 font-medium">${h}</th>`).join('')+'</tr>';
    tbody.innerHTML = rows.map(r=>`
      <tr class="hover:bg-slate-50">
        ${headers.map(h=>`<td class="px-3 py-2 whitespace-nowrap">${r[h] ?? ''}</td>`).join('')}
      </tr>`).join('');
  }

  function exportCSV(){
    const table = $('#dataTable');
    const rows = Array.from(table.querySelectorAll('tr')).map(tr =>
      Array.from(tr.querySelectorAll('th,td')).map(td=>{
        const v = (td.textContent || '').replace(/"/g,'""');
        return `"${v}"`;
      }).join(',')
    ).join('\n');
    const blob = new Blob([rows], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'registros.csv';
    a.click();
  }

  function filterTable(){
    const term = ($('#filterInput').value || '').toLowerCase();
    const rows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
    rows.forEach(tr=>{
      const text = tr.textContent.toLowerCase();
      tr.style.display = text.includes(term) ? '' : 'none';
    });
  }

  /*********** DASH ***********/
  async function loadKPIs(){
    const r = await apiGet({ action:'adminStats', key: state.key });
    const t = r.totals || {};
    $('#kpiEnvios').textContent = t.envios ?? '—';
    $('#kpiActivos').textContent = t.activos ?? '—';
    $('#kpiMaterias').textContent = t.materias ?? '—';
    $('#kpi24').textContent = t.last24 ?? '—';
  }

  async function loadTable(){
    const r = await apiGet({ action:'adminList', key: state.key });
    const items = r.items || [];
    const headers = ['Fecha','Cedula','Nombres','Apellidos','Materia','Parcial','Semana','NumeroTarea','Filename','FileId','FileUrl'];
    const rows = items.map(it => ({
      'Fecha': it.fecha ?? '',
      'Cedula': it.cedula ?? '',
      'Nombres': it.nombres ?? '',
      'Apellidos': it.apellidos ?? '',
      'Materia': it.materia ?? '',
      'Parcial': it.parcial ?? '',
      'Semana': it.semana ?? '',
      'NumeroTarea': it.numeroTarea ?? '',
      'Filename': it.filename ?? '',
      'FileId': it.fileId ?? '',
      'FileUrl': it.fileUrl ?? ''
    }));
    renderTable(headers, rows);
  }

  // Faltantes/enviados con colores y normalización de cédulas (rojo primero)
  async function showFaltantes(){
    const materia = $('#fltMateria').value.trim();
    const parcial = $('#fltParcial').value.trim();
    const semana  = $('#fltSemana').value.trim();
    if (!parcial || !semana){
      $('#faltSummary').textContent = 'Selecciona “Parcial” y “Semana”.';
      $('#faltList').innerHTML = '';
      $('#btnCarpeta').classList.add('hidden');
      return;
    }

    // 1) Traer TODOS los estudiantes
    const allStudents = await apiGet({ action:'adminStudents', key: state.key });
    const students = (allStudents.students || []).map(s => ({
      ced: normId(s.cedula),
      nombres: s.nombres || '',
      apellidos: s.apellidos || ''
    }));

    // 2) Traer TODOS los envíos y filtrar por materia/parcial/semana
    const allSub = await apiGet({ action:'adminList', key: state.key });
    const enviadosSet = new Set(
      (allSub.items || [])
        .filter(r => {
          const okPar = String(r.parcial) === String(parcial);
          const okSem = String(r.semana)  === String(semana);
          const okMat = !materia || r.materia === materia;
          return okPar && okSem && okMat;
        })
        .map(r => normId(r.cedula)) // normalizamos aquí
    );

    // 3) Estadísticas
    const total = students.length;
    const enviados = enviadosSet.size;
    const faltantes = total - enviados;
    $('#faltSummary').textContent = `Total: ${total} • Enviaron: ${enviados} • Faltantes: ${faltantes}`;

    // 4) Render: primero faltantes (rojo), luego enviados (verde)
    const ordered = students.sort((a,b)=>{
      const af = !enviadosSet.has(a.ced);
      const bf = !enviadosSet.has(b.ced);
      if (af !== bf) return af ? -1 : 1; // rojos primero
      return a.apellidos.localeCompare(b.apellidos, 'es');
    });

    $('#faltList').innerHTML = ordered.map(s=>{
      const falta = !enviadosSet.has(s.ced);
      const color = falta
        ? 'bg-red-100 text-red-700 border-red-300'
        : 'bg-emerald-100 text-emerald-700 border-emerald-300';
      return `<div class="px-3 py-2 rounded-xl border ${color}">
        <span class="text-sm">${s.ced} — ${s.apellidos} ${s.nombres}</span>
      </div>`;
    }).join('');

    // 5) Carpeta Drive
    try{
      const f = await apiGet({ action:'adminFolderId', materia, parcial, semana, key: state.key });
      const a = $('#btnCarpeta');
      a.href = f.url;
      a.classList.remove('hidden');
    }catch{
      $('#btnCarpeta').classList.add('hidden');
    }
  }

  function setLoggedIn(v){
    show($('#loginSection'), !v);
    show($('#dashSection'), v);
    show($('#adminBadge'), v);
  }

  async function doLogin(){
    const k = ($('#adminKey').value || '').trim();
    $('#loginMsg').classList.add('hidden');
    try{
      // Validar clave probando un endpoint protegido
      await apiGet({ action:'adminStats', key: k });
      state.key = k;
      sessionStorage.setItem('ADMIN_KEY', k);
      setLoggedIn(true);
      await Promise.all([loadKPIs(), loadTable()]);
    }catch(e){
      $('#loginMsg').textContent = e.message || 'Clave inválida o error de conexión';
      $('#loginMsg').classList.remove('hidden');
    }
  }

  function logout(){
    sessionStorage.removeItem('ADMIN_KEY');
    state.key = '';
    setLoggedIn(false);
  }

  /*********** INIT ***********/
  document.addEventListener('DOMContentLoaded', async ()=>{
    $('#loginBtn').addEventListener('click', doLogin);
    $('#logoutBtn').addEventListener('click', logout);
    $('#refreshBtn').addEventListener('click', async()=>{ await loadKPIs(); await loadTable(); });
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#filterInput').addEventListener('input', filterTable);
    $('#btnFaltantes').addEventListener('click', showFaltantes);

    if (state.key){
      try{
        await apiGet({ action:'adminStats', key: state.key });
        setLoggedIn(true);
        await Promise.all([loadKPIs(), loadTable()]);
      }catch{ setLoggedIn(false); }
    } else {
      setLoggedIn(false);
    }
  });
  </script>
</body>
</html>

